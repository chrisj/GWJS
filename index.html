<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="main.css">

    <script type="text/javascript" src="resources/createjs-2013.05.14.min.js"></script>

    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="worldobject.js"></script>
    <script type="text/javascript" src="grid.js"></script>
    <script type="text/javascript" src="jet.js"></script>
    <script type="text/javascript" src="bullet.js"></script>
    <script type="text/javascript" src="enemy.js"></script>
    <script type="text/javascript" src="triangle.js"></script>
    <script type="text/javascript" src="square.js"></script>
    <script type="text/javascript" src="input.js"></script>

    <script>
    // display
    var FPS = 60;
    var gridColumns = 16;
    var gridRows = 10;
    var worldWidth;
    var worldHeight;

    var canvasWidth;
    var canvasHeight;

    var stage;
    var paused = false;

    // game elements
    var jet;
    var bullets = [];
    var enemies = [];
    var grid;

    var lastSpawnTime;
    var timeBetweenSpawns = 1 * 1000;

    var clockText;
    var startTime;

    function init() {
        //register key functions
        document.onkeydown = handleKeyDown;
        document.onkeyup = handleKeyUp;

        createjs.Ticker.useRAF = true; // learn more about this
        createjs.Ticker.setFPS(FPS);
        createjs.Ticker.addEventListener("tick", tick);

        stage = new createjs.Stage("canvas");
        worldWidth = 100 * gridColumns;
        worldHeight = 100 * gridRows;

        canvasHeight = window.stage.canvas.height;
        canvasWidth = window.stage.canvas.width;

        restart();
    }

    function restart() {
        stage.removeAllChildren();

        leftStickX = 0;
        leftStickY = 0;
        rightStickX = 0;
        rihtStickY = 0;
        lastSpawnTime = 0;

        clockText = new createjs.Text("0", "20px Arial", "#ff7700");
        clockText.x = worldWidth / 2;
        clockText.y = 10;

        stage.addChild(clockText);
        createjs.Tween.get(clockText,{loop:true}).to({alpha:1},500,createjs.Ease.quadOut).to({alpha:0.2},500,createjs.Ease.quadIn);

        startTime = createjs.Ticker.getTime();

        jet = new Jet(worldWidth / 2, worldHeight / 2);
        stage.addChild(jet);

        grid = new Grid();
        stage.addChild(grid);
    }

    function tick(event) {
        // input
        checkGamepad();

        if (!paused) {
            // update game objects
            jet.tick(event);
            grid.tick(event);
            updateBullets(event);
            updateEnemies(event);
            // updateClock(event);

            // draw
            stage.update();
        }
    }

    function updateBullets(event) {
        // move and remove bullets
        bullets.myfilter(function(bullet) {
            bullet.tick(event);

            if (bullet.decay <= 0) {
                stage.removeChild(bullet);
                return true;
            }

            return false;
        });
    }

    function updateEnemies(event) {
        // spawn enemies
        if (event.runTime - lastSpawnTime > timeBetweenSpawns) {
            spawnEnemy();
            lastSpawnTime = event.runTime;
        }

        // move enemies
        for(var i = 0; i < enemies.length; i++){
            enemies[i].tick(event);
        }
    }

    function spawnEnemy(event) {
        var randomLocations = [[10, 10], [worldWidth - 10, worldHeight - 10], [10, worldHeight - 10], [worldWidth - 10, 10]];
        var location = randomLocations[getRandomInt(0, randomLocations.length - 1)]
        var randomEnemyType = Math.floor(Math.random() * 2);
        var enemy;
        switch(randomEnemyType) {
            case 0: enemy = new Triangle(location[0], location[1]); break;
            case 1: enemy = new Square(location[0], location[1]); break;
        }

        stage.addChild(enemy);
        enemies.push(enemy);
    }

    function updateClock(event) {
        var deltaMS = event.runTime - startTime;
        var deltaS = Math.floor(deltaMS / 1000);
        clockText.text = deltaS;
    }

    // function drawGrid() {
    //     var grid = new createjs.Shape();
    //     var g = grid.graphics;

    //     var pixelsPerGridWidth = worldWidth / gridColumns;
    //     var pixelsPerGridHeight = worldHeight / gridRows;

    //     // set grid style
    //     g.setStrokeStyle(.5, "round");
    //     g.beginStroke("#ffffff");

    //     // set grid lines
    //     // g.moveTo(0,0).lineTo(worldWidth, worldHeight);
    //     // g.lineTo(worldWidth, 0);

    //     // g.moveTo(0,0).lineTo(worldWidth, worldHeight);
    //     // g.lineTo(0, worldHeight);


    //     // for(var i = 0; i < gridColumns; i++) {
    //     //     g.moveTo(pixelsPerGridWidth * i, 0).lineTo(pixelsPerGridWidth * i, worldHeight);
    //     // }

    //     // for(var i = 0; i < gridRows; i++) {
    //     //     g.moveTo(0, pixelsPerGridHeight * i).lineTo(worldWidth, pixelsPerGridHeight * i);
    //     // }

    //     //outline grid

    //     g.setStrokeStyle(12);
    //     g.beginFill();
    //     g.drawRect(0,0,worldWidth,worldHeight);

    //     // draw grid
    //     g.endStroke();
    //     stage.addChild(grid);
    // }

    function pauseGame() {
        paused = !paused;
    }
    </script>
</head>
<body onLoad="init();">
    <canvas id="canvas" width="1280" height="720"></canvas>
    <div id="debug"></div>
</body>
</html>
