<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="main.css">

    <script type="text/javascript" src="resources/createjs-2013.05.14.min.js"></script>

    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="jet.js"></script>
    <script type="text/javascript" src="bullet.js"></script>
    <script type="text/javascript" src="triangle.js"></script>
    <script type="text/javascript" src="input.js"></script>

    <script>
    // display
    var FPS = 30;
    var gridColumns = 9;
    var gridRows = 5;
    var canvasWidth;
    var canvasHeight;

    var stage;
    var paused = false;

    // game elements
    var jet;
    var bullets = [];
    var enemies = [];
    var spawnEnemyTimer;
    var spawnEnemyTimerDefault = 1 * FPS;

    var clockText;
    var startTime;

    function init() {
        //register key functions
        document.onkeydown = handleKeyDown;
        document.onkeyup = handleKeyUp;

        createjs.Ticker.useRAF = true; // learn more about this
        createjs.Ticker.setFPS(FPS);
        createjs.Ticker.addEventListener("tick", tick);

        stage = new createjs.Stage("canvas");
        canvasWidth = window.stage.canvas.width;
        canvasHeight = window.stage.canvas.height;

        restart();
    }

    function restart() {
        stage.removeAllChildren();

        drawGrid();

        leftStickX = 0;
        leftStickY = 0;
        rightStickX = 0;
        rihtStickY = 0;
        spawnEnemyTimer = spawnEnemyTimerDefault;

        clockText = new createjs.Text("0", "20px Arial", "#ff7700");
        clockText.x = canvasWidth / 2;
        clockText.y = 10;

        stage.addChild(clockText);
        createjs.Tween.get(clockText,{loop:true}).to({alpha:1},500,createjs.Ease.quadOut).to({alpha:0.2},500,createjs.Ease.quadIn);


        startTime = createjs.Ticker.getTime();

        jet = new Jet();
        jet.x = canvasWidth / 2;
        jet.y = canvasHeight / 2;

        stage.addChild(jet);
    }

    function tick(event) {
        // input
        checkGamepad();

        if (!paused) {
            // update game objects
            jet.tick(event);
            updateBullets();
            updateEnemies();

            updateClock();

            // draw
            stage.update();
        }
    }

    function spawnEnemy(event) {
        var randomLocations = [[10, 10], [canvasWidth - 10, canvasHeight - 10], [10, canvasHeight - 10], [canvasWidth - 10, 10]];
        var location = randomLocations[getRandomInt(0, randomLocations.length - 1)]
        var triangle = new Triangle(location[0], location[1]);
        stage.addChild(triangle);
        enemies.push(triangle);
    }

    function updateBullets(event) {
        // move and remove bullets
        bullets.myfilter(function(bullet) {
            bullet.tick(event);
                
            if (bullet.decay <= 0) {
                stage.removeChild(bullet);
                return true;
            }

            return false;
        });
    }

    function updateEnemies(event) {
        // spawn enemies
        if (spawnEnemyTimer == 0) {
            spawnEnemy();
            spawnEnemyTimer = spawnEnemyTimerDefault;
        } else {
            spawnEnemyTimer -= 1;
        }

        // move enemies
        for(var i = 0; i < enemies.length; i++){
            enemies[i].tick(event);
        }
    }

    function updateClock(event) {
        var deltaMS = createjs.Ticker.getTime() - startTime;
        var deltaS = Math.floor(deltaMS / 1000);
        clockText.text = deltaS;
    }

    function drawGrid() {
        var grid = new createjs.Shape();
        var g = grid.graphics;
        var gh = grid.graphics;

        var pixelsPerGridWidth = canvasWidth / gridColumns;
        var pixelsPerGridHeight = canvasHeight / gridRows;

        // set grid style
        g.setStrokeStyle(.5, "round");
        g.beginStroke("#FFFFFF");

        // set grid lines
        g.moveTo(0,0).lineTo(canvasWidth, canvasHeight);
        g.lineTo(canvasWidth, 0);

        gh.moveTo(0,0).lineTo(canvasWidth, canvasHeight);
        gh.lineTo(0, canvasHeight);


        for(var i = 0; i < gridColumns; i++) {
            g.moveTo(pixelsPerGridWidth * i, 0).lineTo(pixelsPerGridWidth * i, canvasHeight);
        }

        for(var i = 0; i < gridRows; i++) {
            gh.moveTo(0, pixelsPerGridHeight * i).lineTo(canvasWidth, pixelsPerGridHeight * i);
        }

        //outline grid
        
        g.setStrokeStyle(12);
        g.beginFill();
        g.drawRect(0,0,canvasWidth,canvasHeight);

        // draw grid
        g.endStroke();
        stage.addChild(grid);
    }

    function pauseGame() {
        paused = !paused;
    }
    </script>
</head>
<body onLoad="init();">
    <canvas id="canvas" width="900" height="500"></canvas>
    <div id="debug"></div>
</body>
</html>