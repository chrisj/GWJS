<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="main.css">

    <script type="text/javascript" src="resources/createjs-2013.05.14.min.js"></script>

    <script type="text/javascript" src="src/utils.js"></script>
    <script type="text/javascript" src="src/worldobject.js"></script>
    <script type="text/javascript" src="src/grid.js"></script>
    <script type="text/javascript" src="src/jet.js"></script>
    <script type="text/javascript" src="src/bullet.js"></script>
    <script type="text/javascript" src="src/enemy.js"></script>
    <script type="text/javascript" src="src/triangle.js"></script>
    <script type="text/javascript" src="src/square.js"></script>
    <script type="text/javascript" src="src/star.js"></script>
    <script type="text/javascript" src="src/input.js"></script>
    <script type="text/javascript" src="src/particle.js"></script>

    <script>
    "use strict";

    // display
    var FPS = 60;
    var gridColumns = 16;
    var gridRows = 10;
    var worldWidth;
    var worldHeight;

    var canvasWidth;
    var canvasHeight;

    var stage;
    var paused = false;

    // game elements
    var jet;
    var bullets = [];
    var enemies = [];
    var grid;

    var lastSpawnTime;
    var timeBetweenSpawns = 0.5 * 1000;

    var clockText;
    var startTime;

    function init() {
        //register key functions
        document.onkeydown = handleKeyDown;
        document.onkeyup = handleKeyUp;

        createjs.Ticker.useRAF = true; // learn more about this
        createjs.Ticker.setFPS(FPS);
        createjs.Ticker.addEventListener("tick", tick);

        stage = new createjs.Stage("canvas");
        worldWidth = 100 * gridColumns;
        worldHeight = 100 * gridRows;

        canvasHeight = window.stage.canvas.height;
        canvasWidth = window.stage.canvas.width;

        restart();
    }

    function restart() {
        stage.removeAllChildren();

        leftStickX = 0;
        leftStickY = 0;
        rightStickX = 0;
        rightStickY = 0;
        lastSpawnTime = 0;

        clockText = new createjs.Text("0", "40px Arial", "#ff7700");
        clockText.textAlign = "center";
        clockText.x = canvasWidth / 2;
        clockText.y = 10;

        stage.addChild(clockText);
        createjs.Tween.get(clockText,{loop:true}).to({alpha:1},500,createjs.Ease.quadOut).to({alpha:0.2},500,createjs.Ease.quadIn);

        startTime = createjs.Ticker.getTime();

        jet = new Jet(worldWidth / 2, worldHeight / 2);
        stage.addChild(jet);

        grid = new Grid();
        stage.addChild(grid);
    }

    function tick(event) {
        // input
        checkGamepad();

        if (!paused) {
            // update game objects
            jet.tick(event);
            grid.tick(event);
            updateBullets(event);
            updateEnemies(event);
            updateClock(event);

            // draw
            stage.update();
        }
    }

    function updateBullets(event) {
        // move and remove bullets
        bullets.removeIf(function(bullet) {
            bullet.tick(event);

            if (bullet.decay <= 0) {
                stage.removeChild(bullet);
                return true;
            }

            return false;
        });
    }

    function updateEnemies(event) {
        // spawn enemies
        if (event.runTime - lastSpawnTime > timeBetweenSpawns) {
            spawnEnemy();
            lastSpawnTime = event.runTime;
        }

        // move enemies
        enemies.removeIf(function(enemy) {
            if (!enemy.tick(event)) {
                stage.removeChild(enemy);
                return true;
            }

            return false;
        });
    }

    function spawnEnemy(event) {
        var randomLocations = [[10, 10], [worldWidth - 10, worldHeight - 10], [10, worldHeight - 10], [worldWidth - 10, 10]];
        var location = randomLocations[getRandomInt(0, randomLocations.length - 1)]
        var randomEnemyType = getRandomInt(1, 2);

        var enemy;
        switch(randomEnemyType) {
            case 2: enemy = new Triangle(location[0], location[1]); break;
            case 1: enemy = new Square(location[0], location[1]); break;
            case 0: enemy = new Star(location[0], location[1]); break;
        }

        stage.addChild(enemy);
        enemies.push(enemy);
    }

    function updateClock(event) {
        var deltaMS = event.runTime - startTime;
        var deltaS = Math.floor(deltaMS / 1000);
        clockText.text = deltaS;
    }

    function pauseGame() {
        paused = !paused;
    }
    </script>
</head>
<body onLoad="init();">
    <canvas id="canvas" width="1280" height="720"></canvas>
    <div id="debug"></div>
</body>
</html>
